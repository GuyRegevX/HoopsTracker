<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Game Simulator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }

        .header {
            background-color: #1976d2;
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .team-select {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .team-select select {
            padding: 8px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex: 1;
        }

        .vs {
            font-size: 20px;
            font-weight: bold;
        }

        .start-button {
            display: block;
            width: 200px;
            margin: 20px auto;
            padding: 10px;
            font-size: 16px;
            background-color: #2e7d32;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .start-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .game-container {
            display: none;
            gap: 20px;
        }

        .team-container {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .player-select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .stat-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .stat-button {
            padding: 8px 12px;
            font-size: 14px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .stat-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .stats-table th,
        .stats-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .stats-table th {
            background-color: #1976d2;
            color: white;
            font-weight: 500;
        }

        .stats-table tr:last-child td {
            border-bottom: none;
        }

        .stats-table tr:hover {
            background-color: #f5f5f5;
        }

        .stats-section {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-section h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .reset-button {
            display: none;
            width: 200px;
            margin: 20px auto;
            padding: 10px;
            font-size: 16px;
            background-color: #d32f2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .websocket-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            display: none;
        }

        .websocket-status.connected {
            background-color: #2e7d32;
            display: block;
        }

        .websocket-status.disconnected {
            background-color: #d32f2f;
            display: block;
        }

        .websocket-status.connecting {
            background-color: #ed6c02;
            display: block;
        }

        .websocket-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .ws-button {
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .ws-button:not(:disabled) {
            background-color: #1976d2;
            color: white;
        }

        .ws-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .info {
            color: #1976d2;
            text-align: center;
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 4px;
            margin: 10px 0;
        }

        .error {
            color: #f44336;
            text-align: center;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 10px 0;
        }

        .landing-stats-container {
            margin: 20px 0;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .landing-stats-container h3 {
            color: #1976d2;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
        }

        #teamsStatsTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }

        #teamsStatsTable th,
        #teamsStatsTable td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        #teamsStatsTable th {
            background-color: #1976d2;
            color: white;
            font-weight: 500;
        }

        #teamsStatsTable tr:hover {
            background-color: #f5f5f5;
        }

        #teamsStatsTable td:first-child {
            text-align: left;
            font-weight: bold;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>NBA Game Simulator</h1>
    </div>

    <div class="container">
        <div class="team-select">
            <select id="homeTeam">
                <option value="">Select Home Team</option>
            </select>
            <span class="vs">VS</span>
            <select id="awayTeam">
                <option value="">Select Away Team</option>
            </select>
        </div>

        <div class="websocket-controls">
            <button id="connectWsButton" class="ws-button">Connect WebSocket</button>
            <button id="disconnectWsButton" class="ws-button" disabled>Disconnect WebSocket</button>
        </div>

        <button id="startButton" class="start-button" disabled>Start Game</button>
        <button id="resetButton" class="reset-button">Stop Game</button>

        <!-- Landing page stats table -->
        <div id="landingStats" class="landing-stats-container">
            <div class="stats-section">
                <h3>NBA Teams Statistics</h3>
                <table class="stats-table" id="teamsStatsTable">
                    <thead>
                        <tr>
                            <th>Team</th>
                            <th>PPG</th>
                            <th>APG</th>
                            <th>RPG</th>
                            <th>SPG</th>
                            <th>BPG</th>
                            <th>TOPG</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="gameContainer" class="game-container">
            <div class="team-container">
                <h2 id="homeTeamName"></h2>
                <select id="homePlayer" class="player-select">
                    <option value="">Select Player</option>
                </select>
                <div class="stat-buttons" id="homeStatButtons"></div>
                
                <!-- Home Team Stats Section -->
                <div class="stats-section">
                    <h3>Team Stats</h3>
                    <table class="stats-table" id="homeTeamStats">
                        <thead>
                            <tr>
                                <th>Stat</th>
                                <th>Game Value</th>
                                <th>Season Avg</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Home Players Stats Section -->
                <div class="stats-section">
                    <h3>Player Stats</h3>
                    <table class="stats-table" id="homePlayerStats">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>PTS</th>
                                <th>AST</th>
                                <th>REB</th>
                                <th>STL</th>
                                <th>BLK</th>
                                <th>TO</th>
                                <th>Season PPG</th>
                                <th>Season APG</th>
                                <th>Season RPG</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="team-container">
                <h2 id="awayTeamName"></h2>
                <select id="awayPlayer" class="player-select">
                    <option value="">Select Player</option>
                </select>
                <div class="stat-buttons" id="awayStatButtons"></div>
                
                <!-- Away Team Stats Section -->
                <div class="stats-section">
                    <h3>Team Stats</h3>
                    <table class="stats-table" id="awayTeamStats">
                        <thead>
                            <tr>
                                <th>Stat</th>
                                <th>Game Value</th>
                                <th>Season Avg</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Away Players Stats Section -->
                <div class="stats-section">
                    <h3>Player Stats</h3>
                    <table class="stats-table" id="awayPlayerStats">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>PTS</th>
                                <th>AST</th>
                                <th>REB</th>
                                <th>STL</th>
                                <th>BLK</th>
                                <th>TO</th>
                                <th>Season PPG</th>
                                <th>Season APG</th>
                                <th>Season RPG</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="websocket-status">WebSocket: Connecting...</div>

        <script>
            const teams = {
                lakers: {
                    id: '1',
                    name: 'Los Angeles Lakers',
                    players: [
                        { id: '1', name: 'LeBron James', stats: {} },
                        { id: '2', name: 'Anthony Davis', stats: {} },
                        { id: '3', name: 'Austin Reaves', stats: {} }
                    ]
                },
                celtics: {
                    id: '2',
                    name: 'Boston Celtics',
                    players: [
                        { id: '4', name: 'Jayson Tatum', stats: {} },
                        { id: '5', name: 'Jaylen Brown', stats: {} },
                        { id: '6', name: 'Kristaps Porzingis', stats: {} }
                    ]
                },
                warriors: {
                    id: '3',
                    name: 'Golden State Warriors',
                    players: [
                        { id: '7', name: 'Stephen Curry', stats: {} },
                        { id: '8', name: 'Klay Thompson', stats: {} },
                        { id: '9', name: 'Draymond Green', stats: {} }
                    ]
                },
                bucks: {
                    id: '4',
                    name: 'Milwaukee Bucks',
                    players: [
                        { id: '10', name: 'Giannis Antetokounmpo', stats: {} },
                        { id: '11', name: 'Damian Lillard', stats: {} },
                        { id: '12', name: 'Khris Middleton', stats: {} }
                    ]
                },
                nuggets: {
                    id: '5',
                    name: 'Denver Nuggets',
                    players: [
                        { id: '13', name: 'Nikola Jokic', stats: {} },
                        { id: '14', name: 'Jamal Murray', stats: {} },
                        { id: '15', name: 'Michael Porter Jr.', stats: {} }
                    ]
                }
            };

            const statTypes = [
                { id: 'pts2', label: '2 Points', value: 2, type: 'points' },
                { id: 'pts3', label: '3 Points', value: 3, type: 'points' },
                { id: 'ast', label: 'Assist', value: 1, type: 'assists' },
                { id: 'reb', label: 'Rebound', value: 1, type: 'rebounds' },
                { id: 'stl', label: 'Steal', value: 1, type: 'steals' },
                { id: 'blk', label: 'Block', value: 1, type: 'blocks' },
                { id: 'to', label: 'Turnover', value: 1, type: 'turnovers' }
            ];

            let gameState = {
                homeTeam: '',
                awayTeam: '',
                homePlayers: [],
                awayPlayers: []
            };

            let ws = null;
            let selectedPlayer = null;
            const currentSeasonId = "1"; // Hardcoded season ID

            // DOM Elements
            const homeTeamSelect = document.getElementById('homeTeam');
            const awayTeamSelect = document.getElementById('awayTeam');
            const startButton = document.getElementById('startButton');
            const resetButton = document.getElementById('resetButton');
            const gameContainer = document.getElementById('gameContainer');
            const homePlayerSelect = document.getElementById('homePlayer');
            const awayPlayerSelect = document.getElementById('awayPlayer');
            const homeTeamName = document.getElementById('homeTeamName');
            const awayTeamName = document.getElementById('awayTeamName');
            const homeStatButtons = document.getElementById('homeStatButtons');
            const awayStatButtons = document.getElementById('awayStatButtons');
            const homePlayerStats = document.getElementById('homePlayerStats');
            const awayPlayerStats = document.getElementById('awayPlayerStats');
            const connectWsButton = document.getElementById('connectWsButton');
            const disconnectWsButton = document.getElementById('disconnectWsButton');
            const gameStats = document.getElementById('gameStats');

            // Initialize landing page stats
            updateAllTeamsStats();

            function validateTeamSelection() {
                const homeTeam = homeTeamSelect.value;
                const awayTeam = awayTeamSelect.value;
                startButton.disabled = !homeTeam || !awayTeam || homeTeam === awayTeam;
            }

            function createStatButtons(container, isHome) {
                container.innerHTML = '';
                statTypes.forEach(stat => {
                    const button = document.createElement('button');
                    button.className = 'stat-button';
                    button.textContent = stat.label;
                    button.onclick = () => updateStats(isHome, stat);
                    container.appendChild(button);
                });
            }

            let wsReconnectAttempts = 0;
            const MAX_RECONNECT_ATTEMPTS = 5;
            const RECONNECT_DELAY = 1000;

            function updateWebSocketStatus(status) {
                const statusElement = document.querySelector('.websocket-status');
                statusElement.className = 'websocket-status ' + status;
                statusElement.textContent = 'WebSocket: ' + status.charAt(0).toUpperCase() + status.slice(1);
            }

            function connectWebSocket() {
                updateWebSocketStatus('connecting');
                ws = new WebSocket('ws://localhost:8082/ws/game_live_update');
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                    updateWebSocketStatus('connected');
                    wsReconnectAttempts = 0;
                    connectWsButton.disabled = true;
                    disconnectWsButton.disabled = false;
                };
                
                ws.onclose = () => {
                    updateWebSocketStatus('disconnected');
                    connectWsButton.disabled = false;
                    disconnectWsButton.disabled = true;
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateWebSocketStatus('disconnected');
                    connectWsButton.disabled = false;
                    disconnectWsButton.disabled = true;
                };
                
                ws.onmessage = handleWebSocketMessage;
            }

            function disconnectWebSocket() {
                if (ws) {
                    ws.close();
                }
            }

            function handleWebSocketMessage(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'statUpdate') {
                    updatePlayerDisplay(data);
                    fetchTeamYearlyStats();
                    fetchPlayerYearlyStats();
                }
            }

            function updateStats(isHome, stat) {
                const playerSelect = isHome ? homePlayerSelect : awayPlayerSelect;
                const playerId = playerSelect.value;
                if (!playerId) return;

                const data = {
                    type: 'statUpdate',
                    playerId: playerId,
                    field: stat.type,
                    value: stat.value,
                    isHome: isHome
                };

                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(data));
                } else {
                    console.error('WebSocket is not connected');
                }
            }

            function updatePlayerDisplay(data) {
                // Update the appropriate team's stats table
                if (data.isHome) {
                    updateTeamStats(homePlayerStats, gameState.homePlayers);
                } else {
                    updateTeamStats(awayPlayerStats, gameState.awayPlayers);
                }
            }

            function populatePlayerSelect(select, players) {
                select.innerHTML = '<option value="">Select Player</option>';
                
                // Sort players alphabetically
                const sortedPlayers = [...players].sort((a, b) => a.name.localeCompare(b.name));
                
                sortedPlayers.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = player.name;
                    select.appendChild(option);
                });
            }

            function startGame() {
                gameState.homeTeam = homeTeamSelect.value;
                gameState.awayTeam = awayTeamSelect.value;
                gameState.homePlayers = JSON.parse(JSON.stringify(teams[gameState.homeTeam].players));
                gameState.awayPlayers = JSON.parse(JSON.stringify(teams[gameState.awayTeam].players));

                homeTeamName.textContent = teams[gameState.homeTeam].name;
                awayTeamName.textContent = teams[gameState.awayTeam].name;

                populatePlayerSelect(homePlayerSelect, gameState.homePlayers);
                populatePlayerSelect(awayPlayerSelect, gameState.awayPlayers);

                createStatButtons(homeStatButtons, true);
                createStatButtons(awayStatButtons, false);

                gameContainer.style.display = 'flex';
                document.getElementById('landingStats').style.display = 'none';
                startButton.style.display = 'none';
                resetButton.style.display = 'block';
                homeTeamSelect.disabled = true;
                awayTeamSelect.disabled = true;

                updateStatsDisplay();
            }

            function resetGame() {
                gameState = {
                    homeTeam: '',
                    awayTeam: '',
                    homePlayers: [],
                    awayPlayers: []
                };

                gameContainer.style.display = 'none';
                document.getElementById('landingStats').style.display = 'block';
                startButton.style.display = 'block';
                resetButton.style.display = 'none';
                homeTeamSelect.disabled = false;
                awayTeamSelect.disabled = false;
                homeTeamSelect.value = '';
                awayTeamSelect.value = '';
                validateTeamSelection();

                // Update landing page stats
                updateAllTeamsStats();
            }

            function updateStatsDisplay() {
                updateTeamStats(homePlayerStats, gameState.homePlayers);
                updateTeamStats(awayPlayerStats, gameState.awayPlayers);
            }

            function updateTeamStats(container, players) {
                const tbody = container.querySelector('tbody');
                const isHomeTeam = container.id === 'homePlayerStats';
                const teamId = isHomeTeam ? teams[gameState.homeTeam].id : teams[gameState.awayTeam].id;
                
                // Fetch team season stats
                fetch(`http://localhost:8080/api/v1/teams/${teamId}/stats?seasonId=${currentSeasonId}`)
                    .then(response => response.json())
                    .then(teamSeasonStats => {
                        // Get all player IDs for batch fetch
                        const playerIds = players.map(p => p.id);
                        
                        // Fetch all players' season stats in one request
                        return fetch(`http://localhost:8080/api/v1/players/stats?seasonId=${currentSeasonId}&playerIds=${playerIds.join(',')}`)
                            .then(response => response.json())
                            .then(playerSeasonStats => {
                                tbody.innerHTML = '';
                                
                                // Sort players alphabetically by name
                                const sortedPlayers = [...players].sort((a, b) => a.name.localeCompare(b.name));
                                
                                sortedPlayers.forEach(player => {
                                    const seasonStats = playerSeasonStats[player.id] || {};
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${player.name}</td>
                                        <td>${player.stats.points || 0}</td>
                                        <td>${player.stats.assists || 0}</td>
                                        <td>${player.stats.rebounds || 0}</td>
                                        <td>${player.stats.steals || 0}</td>
                                        <td>${player.stats.blocks || 0}</td>
                                        <td>${player.stats.turnovers || 0}</td>
                                        <td>${seasonStats.ppg?.toFixed(1) || '0.0'}</td>
                                        <td>${seasonStats.apg?.toFixed(1) || '0.0'}</td>
                                        <td>${seasonStats.rpg?.toFixed(1) || '0.0'}</td>
                                    `;
                                    tbody.appendChild(row);
                                });

                                // Update team stats table
                                const teamStatsTable = document.getElementById(isHomeTeam ? 'homeTeamStats' : 'awayTeamStats');
                                const teamStatsTbody = teamStatsTable.querySelector('tbody');
                                const stats = [
                                    { label: 'Points', game: 'points', season: 'ppg' },
                                    { label: 'Assists', game: 'assists', season: 'apg' },
                                    { label: 'Rebounds', game: 'rebounds', season: 'rpg' },
                                    { label: 'Steals', game: 'steals', season: 'spg' },
                                    { label: 'Blocks', game: 'blocks', season: 'bpg' },
                                    { label: 'Turnovers', game: 'turnovers', season: 'topg' }
                                ];

                                teamStatsTbody.innerHTML = '';
                                stats.forEach(stat => {
                                    const gameTotal = sortedPlayers.reduce((sum, player) => sum + (player.stats[stat.game] || 0), 0);
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${stat.label}</td>
                                        <td>${gameTotal}</td>
                                        <td>${teamSeasonStats[stat.season]?.toFixed(1) || '0.0'}</td>
                                    `;
                                    teamStatsTbody.appendChild(row);
                                });
                            });
                    })
                    .catch(error => {
                        console.error('Error updating stats:', error);
                    });
            }

            function fetchTeamYearlyStats(teamKey, containerId) {
                const container = document.getElementById(containerId);
                const tbody = container.querySelector('tbody');
                tbody.innerHTML = '';

                const teamId = teams[teamKey].id;
                
                fetch(`http://localhost:8080/api/v1/teams/${teamId}/stats?seasonId=${currentSeasonId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const stats = [
                            { key: 'ppg', label: 'Points per Game' },
                            { key: 'apg', label: 'Assists per Game' },
                            { key: 'rpg', label: 'Rebounds per Game' },
                            { key: 'spg', label: 'Steals per Game' },
                            { key: 'bpg', label: 'Blocks per Game' },
                            { key: 'topg', label: 'Turnovers per Game' }
                        ];
                        
                        stats.forEach(({ key, label }) => {
                            if (data[key] !== undefined) {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${label}</td>
                                    <td>${data[key].toFixed(2)}</td>
                                `;
                                tbody.appendChild(row);
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching team stats:', error);
                        tbody.innerHTML = '<tr><td colspan="2" class="error">Failed to load team stats</td></tr>';
                    });
            }

            function fetchPlayerYearlyStats(playerId, containerId) {
                if (!playerId) return;
                
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const box = container.closest('.yearly-stats-box');
                box.classList.add('loading');

                // Find the selected player object
                let selectedPlayerObj = null;
                if (gameState.homeTeam) {
                    selectedPlayerObj = gameState.homePlayers.find(p => p.id === playerId) ||
                                      gameState.awayPlayers.find(p => p.id === playerId);
                } else {
                    // For landing page, look in the teams object
                    Object.values(teams).forEach(team => {
                        const found = team.players.find(p => p.id === playerId);
                        if (found) selectedPlayerObj = found;
                    });
                }
                
                if (!selectedPlayerObj) {
                    box.classList.remove('loading');
                    container.innerHTML = '<div class="error">Player not found</div>';
                    return;
                }

                fetch(`http://localhost:8080/api/v1/players/${playerId}/stats?seasonId=${currentSeasonId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Create new content
                        const newContent = [];
                        
                        // Add player name header
                        newContent.push(`<div class="yearly-stat-item player-name"><strong>${selectedPlayerObj.name}</strong></div>`);
                        
                        // Add games played if available
                        if (data.games !== undefined) {
                            newContent.push(`<div class="yearly-stat-item"><span>Games Played</span><span>${data.games}</span></div>`);
                        }
                        
                        // Add all available stats
                        const stats = [
                            { key: 'ppg', label: 'Points' },
                            { key: 'apg', label: 'Assists' },
                            { key: 'rpg', label: 'Rebounds' },
                            { key: 'spg', label: 'Steals' },
                            { key: 'bpg', label: 'Blocks' },
                            { key: 'topg', label: 'Turnovers' }
                        ];
                        
                        stats.forEach(({ key, label }) => {
                            if (data[key] !== undefined) {
                                newContent.push(`<div class="yearly-stat-item"><span>${label}</span><span>${data[key].toFixed(2)}</span></div>`);
                            }
                        });

                        const newContentString = newContent.join('');
                        
                        // Only update if content has changed
                        if (container.innerHTML !== newContentString) {
                            container.innerHTML = newContentString;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching player stats:', error);
                        container.innerHTML = '<div class="error">Failed to load player stats</div>';
                    })
                    .finally(() => {
                        box.classList.remove('loading');
                    });
            }

            // Event Listeners
            homeTeamSelect.addEventListener('change', validateTeamSelection);
            awayTeamSelect.addEventListener('change', validateTeamSelection);
            startButton.addEventListener('click', startGame);
            resetButton.addEventListener('click', resetGame);
            connectWsButton.addEventListener('click', connectWebSocket);
            disconnectWsButton.addEventListener('click', disconnectWebSocket);

            homePlayerSelect.addEventListener('change', (e) => {
                const playerId = e.target.value;
                if (playerId) {
                    fetchPlayerYearlyStats(playerId, 'homePlayerYearlyStats');
                } else {
                    const container = document.getElementById('homePlayerYearlyStats');
                    container.innerHTML = '<div class="info">Select a player to view stats</div>';
                }
            });

            awayPlayerSelect.addEventListener('change', (e) => {
                const playerId = e.target.value;
                if (playerId) {
                    fetchPlayerYearlyStats(playerId, 'awayPlayerYearlyStats');
                } else {
                    const container = document.getElementById('awayPlayerYearlyStats');
                    container.innerHTML = '<div class="info">Select a player to view stats</div>';
                }
            });
            
            // Start polling for stats updates
            setInterval(() => {
                if (gameState.homeTeam) {
                    fetchTeamYearlyStats(gameState.homeTeam, 'homeTeamYearlyStats');
                    fetchTeamYearlyStats(gameState.awayTeam, 'awayTeamYearlyStats');
                } else {
                    updateAllTeamsStats();
                }
            }, 2000);

            // Update the team selection options
            function populateTeamSelects() {
                const homeSelect = document.getElementById('homeTeam');
                const awaySelect = document.getElementById('awayTeam');

                // Clear existing options except the first one
                while (homeSelect.options.length > 1) homeSelect.remove(1);
                while (awaySelect.options.length > 1) awaySelect.remove(1);

                // Convert teams object to array and sort by name
                const teamsList = Object.entries(teams)
                    .map(([key, team]) => ({ key, ...team }))
                    .sort((a, b) => a.name.localeCompare(b.name));

                // Add team options
                teamsList.forEach(team => {
                    const homeOption = new Option(team.name, team.key);
                    const awayOption = new Option(team.name, team.key);
                    
                    homeSelect.add(homeOption);
                    awaySelect.add(awayOption);
                });
            }

            function updateAllTeamsStats() {
                const teamsTable = document.getElementById('teamsStatsTable').querySelector('tbody');
                
                // Convert teams object to array and sort by name
                const teamsList = Object.entries(teams)
                    .map(([key, team]) => ({ key, ...team }))
                    .sort((a, b) => a.name.localeCompare(b.name));
                
                // Fetch all teams stats in a single request
                fetch(`http://localhost:8080/api/v1/teams/stats?seasonId=${currentSeasonId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(allTeamsStats => {
                        teamsList.forEach(team => {
                            const teamStats = allTeamsStats[team.id];
                            const existingRow = teamsTable.querySelector(`[data-team-id="${team.id}"]`);
                            const statsHtml = `
                                <td>${team.name}</td>
                                <td>${teamStats?.ppg ? teamStats.ppg.toFixed(1) : '0.0'}</td>
                                <td>${teamStats?.apg ? teamStats.apg.toFixed(1) : '0.0'}</td>
                                <td>${teamStats?.rpg ? teamStats.rpg.toFixed(1) : '0.0'}</td>
                                <td>${teamStats?.spg ? teamStats.spg.toFixed(1) : '0.0'}</td>
                                <td>${teamStats?.bpg ? teamStats.bpg.toFixed(1) : '0.0'}</td>
                                <td>${teamStats?.topg ? teamStats.topg.toFixed(1) : '0.0'}</td>
                            `;

                            if (existingRow) {
                                // Only update if content is different
                                if (existingRow.innerHTML !== statsHtml) {
                                    existingRow.innerHTML = statsHtml;
                                }
                            } else {
                                const row = document.createElement('tr');
                                row.setAttribute('data-team-id', team.id);
                                row.innerHTML = statsHtml;
                                teamsTable.appendChild(row);
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching all teams stats:', error);
                        teamsList.forEach(team => {
                            const existingRow = teamsTable.querySelector(`[data-team-id="${team.id}"]`);
                            const errorHtml = `
                                <td>${team.name}</td>
                                <td colspan="6" class="error">Failed to load stats</td>
                            `;
                            
                            if (existingRow) {
                                existingRow.innerHTML = errorHtml;
                            } else {
                                const row = document.createElement('tr');
                                row.setAttribute('data-team-id', team.id);
                                row.innerHTML = errorHtml;
                                teamsTable.appendChild(row);
                            }
                        });
                    });
            }

            // Initialize the page
            document.addEventListener('DOMContentLoaded', () => {
                populateTeamSelects();
                updateAllTeamsStats();
            });
        </script>
    </div>

    <div class="websocket-status">WebSocket: Connecting...</div>
</body>
</html> 